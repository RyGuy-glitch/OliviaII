# v0.4.3 — HA controls, SHADOW mode, Nuclear, Correlation, Adaptive Risk, FTMO profile, Dashboard/Digest, CI

## Summary

Safety‑first release. Introduces High Availability (HA) controls, leadership fencing, SHADOW mode aliasing, nuclear lock with Prague‑day nonce, correlation/DXY policy, adaptive risk adapter, FTMO helpers, partial fills policy, gap halt, dashboard badge + nightly digest, parity adapter stubs, and CI gates. **All new features default OFF behind flags.**

## What changed (Commits 02–15)

* **HA & Leadership**: Redis TTL 3000ms, heartbeat 1000ms, fencing tokens, auto flat‑all on lock loss (flag, debounced), `/ha/status` + UI badge.
* **Modes**: `HONEYPOT → SHADOW` alias; `X-Wolfe-Mode` watermark; SHADOW has zero broker side‑effects and writes to `logs/shadow/`.
* **Nuclear**: Public‑key (Ed25519) verify against **current Prague day nonce**; engage → FLAT\_ALL + lockdown; single `/nuclear/re-enable` endpoint to resume.
* **Correlation + DXY**: Rolling 20D pairwise; threshold 0.70; action `block|halve`; USD cluster action when `|ΔDXY| ≤ band`.
* **Adaptive Risk Adapter**: Modes `ratchet|adaptive|both`; emits `RISK_ADAPT_APPLIED` only when adaptive constrains; feature‑gated in sizing.
* **Gap/Corp‑Action Guard**: `|open - prev_close|/prev_close ≥ 15%` → `GAP_HALT` (flag). Resume path.
* **Partial Fills**: Always emit `PARTIAL_FILL {requested, filled, elapsed_ms, action}`; `<60% && spread>cap` → `cancel_remainder|retry_smaller`.
* **FTMO Profile**: Friday cutoff (GMT), Phase 2 per‑trade risk cap.
* **Dashboard/Digest**: HA status chip; nightly digest @ 23:30 ET with attribution and panels.
* **Adapters**: MT5 `flat_all()` hook (SHADOW‑safe); cTrader/DXtrade **stubs + parity replay**.
* **Events/Schema**: Reason codes wired; schema guard.
* **Backoff**: Deterministic jitter plan for tests.
* **CI**: pytest + coverage (changed files ≥85%), ruff, black, mypy; `pytest.ini` with quiet defaults.

## Config keys & defaults (YAML → env mirrors)

```yaml
# config/default.yaml
modes:
  executor_mode: SHADOW            # env: EXECUTOR_MODE
correlation:
  window_days: 20                  # env: CORR_WINDOW_DAYS
  block_threshold: 0.70            # env: CORR_BLOCK_THRESHOLD
  block_threshold_action: block    # env: CORR_THRESHOLD_ACTION
  dxy_band_pct: 0.002              # env: DXY_BAND_PCT
gap:
  alert_pct: 0.15                  # env: GAP_ALERT_PCT
risk:
  mode: ratchet                    # env: RISK_MODE
  floor_pct: 0.25                  # env: RISK_FLOOR_PCT
  ceiling_pct: 1.50                # env: RISK_CEILING_PCT
features:
  ha_drills: false                 # env: FEATURES_HA_DRILLS
  ha_status_badge: true            # env: FEATURES_HA_STATUS_BADGE
  auto_flat_all_on_lock_loss: false# env: FEATURES_AUTO_FLAT_ALL_ON_LOCK_LOSS
  auto_register_mt5: false         # env: FEATURES_AUTO_REGISTER_MT5
  gap_guard: false                 # env: FEATURES_GAP_GUARD
  risk_adapter: false              # env: FEATURES_RISK_ADAPTER
```

## Feature flags (default OFF)

| Flag                                  | Default | Module(s)                           | Tests                                           |
| ------------------------------------- | ------: | ----------------------------------- | ----------------------------------------------- |
| `FEATURES_HA_DRILLS`                  |   false | `ops/ha/*`                          | `tests/drills/test_ha_split_brain.py`           |
| `FEATURES_AUTO_FLAT_ALL_ON_LOCK_LOSS` |   false | `ops/ha/bootstrap.py`               | `tests/drills/test_ha_on_loss_debounce.py`      |
| `FEATURES_HA_STATUS_BADGE`            |    true | `ops/dashboard/app.py`              | (UI manual; endpoint covered)                   |
| `FEATURES_RISK_ADAPTER`               |   false | `engine/risk.py`, `risk/adapters/*` | `tests/integration/test_sizing_with_adapter.py` |
| `FEATURES_AUTO_REGISTER_MT5`          |   false | `core/executor/bootstrap.py`        | `tests/executor/test_bootstrap.py`              |
| `FEATURES_GAP_GUARD`                  |   false | `engine/ComplianceGuard/core.py`    | `tests/acceptance/test_gap_guard.py`            |

## Reason codes wired

`HA_LOCK_LOST`, `FLAT_ALL_EXECUTED`, `GAP_HALT`, `PARTIAL_FILL`, `RISK_ADAPT_APPLIED`, `CORR_BLOCK`, `NUCLEAR_LOCKED`, `NUCLEAR_RESUMED`.

## Acceptance drills (what each proves)

* `tests/drills/test_ha_split_brain.py`: SHADOW/DRY\_RUN/LIVE flat\_all behaviors; idempotence.
* `tests/drills/test_ha_on_loss_debounce.py`: 5s debounce + once‑only emission.
* `tests/acceptance/test_correlation_controls.py`: block/halve, window effect, DXY regime.
* `tests/acceptance/test_gap_guard.py`: 14.9% vs 15.0% boundary; resume path.
* `tests/execution/test_partial_fills.py`: 60%+spread policy and actions.
* `tests/risk/test_risk_adapter.py`: floor/ceiling; mode transitions; reason only when adaptive constrains.
* `tests/integration/test_sizing_with_adapter.py`: feature‑gated min rule + emissions.
* `tests/utils/test_backoff.py`: deterministic jitter.
* `tests/events/test_event_schema.py`: reason code allowlist.
* `tests/profiles/test_ftmo.py`: Friday cutoff + per‑trade cap.

## How to smoke‑run locally

```bash
python -m compileall -q .
python scripts/dev_run.py --mode SHADOW --badge
```

## CI gates

* ruff, black (check), mypy (non‑blocking), pytest with coverage XML, and **changed‑file coverage ≥85%** via `.ci/coverage_gate.py`.

## Risks & mitigations

* LIVE guarded by flags; **SHADOW** is watermark‑only and side‑effect‑free; `SAFETY_NO_LIVE=1` defaulted in dev launcher.

## Rollback

* Flip feature flags **OFF** and revert PR; no schema migrations required.

**Labels**: `release:v0.4.3`, `area:ha`, `area:risk`, `area:ui`, `ci`, `safe-by-default`

---

## tools/spec\_diff.py

```python
# path: tools/spec_diff.py
"""
Spec diff helper (0.4.2 → 0.4.3).

Usage:
  python tools/spec_diff.py --from specs/v0_4_2.md --to specs/v0_4_3_delta.md

Outputs Markdown to stdout; always exits 0.
No external dependencies.
"""
from __future__ import annotations

import argparse
import sys
from dataclasses import dataclass
from pathlib import Path
from typing import Dict, List, Tuple


@dataclass
class Row:
    section: str
    delta: str
    files: str
    tests: str
    status: str


# Keyword heuristics to mark ✅ when present in the "to" doc
KEYS = {
    "HA / Leader": ["TTL", "fencing", "split_brain", "leader", "heartbeat"],
    "Modes": ["SHADOW", "HONEYPOT"],
    "Gap Guard": ["gap", "15%"],
    "Backoff": ["backoff", "100ms", "5000"],
    "Partial Fills": ["partial", "60%", "spread"],
    "Nuclear": ["Ed25519", "Prague", "nonce", "re-enable"],
    "Adaptive Risk": ["adaptive", "ratchet", "both"],
    "Correlation": ["20D", "0.70", "DXY"],
    "FTMO Profile": ["FTMO", "Friday", "phase"],
    "Dashboard/Digest": ["badge", "digest", "23:30"],
    "Adapters": ["cTrader", "DXtrade", "MT5"],
    "Events Bus": ["reason", "schema", "emit"],
    "Flags/Migrations": ["flag", "default", "OFF", "0.4.3"],
}

DELTA_TEXT = {
    "HA / Leader": "TTL=3s, fencing, SPLIT_BRAIN",
    "Modes": "SHADOW + alias HONEYPOT",
    "Gap Guard": "15% halt",
    "Backoff": "100→5000ms +±200ms",
    "Partial Fills": "enum + 60% branch",
    "Nuclear": "Ed25519, Prague nonce, endpoint",
    "Adaptive Risk": "modes + reason",
    "Correlation": "20D, 0.70, DXY band",
    "FTMO Profile": "pacing, per-trade cap, Friday cutoff",
    "Dashboard/Digest": "badges, nightly digest",
    "Adapters": "MT5 + stubs for cTrader/DXtrade",
    "Events Bus": "schema/emit",
    "Flags/Migrations": "default OFF, 042→043",
}

FILES_TEXT = {
    "HA / Leader": "infra/ha/*",
    "Modes": "core/executor/*, ops/dashboard/*",
    "Gap Guard": "engine/ComplianceGuard/core.py",
    "Backoff": "shared/utils/backoff.py",
    "Partial Fills": "engine/execution/partial_fills.py",
    "Nuclear": "security/nuclear.py, server/api/nuclear.py",
    "Adaptive Risk": "risk/adapters/risk_adapter.py, engine/risk.py",
    "Correlation": "engine/CopyDeCorr/core.py, engine/ComplianceGuard/core.py",
    "FTMO Profile": "engine/profiles/ftmo.py",
    "Dashboard/Digest": "ops/dashboard/app.py, scripts/digest.py",
    "Adapters": "adapters/*",
    "Events Bus": "shared/events/schema.py, shared/events/bus.py",
    "Flags/Migrations": "config/*, migrations/*",
}

TESTS_TEXT = {
    "HA / Leader": "tests/drills/test_ha_split_brain.py",
    "Modes": "tests/mode/*",
    "Gap Guard": "tests/acceptance/test_gap_guard.py",
    "Backoff": "tests/utils/test_backoff.py",
    "Partial Fills": "tests/execution/test_partial_fills.py",
    "Nuclear": "tests/nuclear/test_nuclear_flow.py",
    "Adaptive Risk": "tests/risk/test_risk_adapter.py, tests/integration/test_sizing_with_adapter.py",
    "Correlation": "tests/acceptance/test_correlation_controls.py",
    "FTMO Profile": "tests/profiles/test_ftmo.py",
    "Dashboard/Digest": "tests/ops/test_digest.py",
    "Adapters": "tests/adapters/*",
    "Events Bus": "tests/events/test_event_schema.py",
    "Flags/Migrations": "tests/migrations/*",
}


def has_all(hay: str, needles: List[str]) -> bool:
    hay_low = hay.lower()
    return all(n.lower() in hay_low for n in needles)


def build_rows(src_text: str, dst_text: str) -> List[Row]:
    rows: List[Row] = []
    for section, needles in KEYS.items():
        status = "✅" if has_all(dst_text, needles) else ("⚠️" if any(n.lower() in dst_text.lower() for n in needles) else "⬜")
        rows.append(
            Row(
                section=section,
                delta=DELTA_TEXT.get(section, ""),
                files=FILES_TEXT.get(section, ""),
                tests=TESTS_TEXT.get(section, ""),
                status=status,
            )
        )
    return rows


def render(rows: List[Row]) -> str:
    out = ["## Spec Diff (0.4.2 → 0.4.3)", "| Section | Delta | Files | Tests | Status |", "|---|---|---|---|---|"]
    for r in rows:
        out.append(f"| {r.section} | {r.delta} | {r.files} | {r.tests} | {r.status} |")
    return "\n".join(out)


def main(argv: List[str]) -> int:
    ap = argparse.ArgumentParser()
    ap.add_argument("--from", dest="src", required=True)
    ap.add_argument("--to", dest="dst", required=True)
    args = ap.parse_args(argv)

    try:
        src_text = Path(args.src).read_text(encoding="utf-8", errors="ignore")
    except Exception:
        src_text = ""
    try:
        dst_text = Path(args.dst).read_text(encoding="utf-8", errors="ignore")
    except Exception:
        dst_text = ""

    rows = build_rows(src_text, dst_text)
    print(render(rows))
    return 0


if __name__ == "__main__":
    raise SystemExit(main(sys.argv[1:]))
```

# path: docs/PR_v043.md
# v0.4.3 — HA controls, SHADOW mode, Nuclear, Correlation, Adaptive Risk, FTMO profile, Dashboard/Digest, CI

*(This is the PR body; copy into GitHub if not auto-included.)*

## Summary
Safety‑first release. All new features default **OFF**. Adds HA leadership with fencing tokens, SHADOW watermark mode, nuclear lock + Prague day‑nonce, correlation+DXY policy, adaptive risk adapter, FTMO helpers, partial fills, gap halt, dashboard badge + nightly digest, parity adapter stubs, and CI coverage gates.

## What changed (Commits 02–15)
(…same as PR draft we previously provided…)

## Spec diff
Run: `python tools/spec_diff.py --from specs/v0_4_2.md --to specs/v0_4_3_delta.md` and paste below.
